# -*- mode: sh -*-
[DEFAULT]
# Include all available libs.
include =
    if [ -d ~/src/mr/lib ]; then
        cat ~/src/mr/lib/*
    elif [ -d /usr/share/mr ]; then
        cat /usr/share/mr/* 2>/dev/null || true
    fi
# Teach mr to run a few git and svn specific commands.
svn_cleanup = svn cleanup "$@"
git_gc = git gc "$@"
git_tag = git tag -l
svn_tag = svn ls "$(LC_ALL=C svn info . | grep -i ^URL: | cut -d ' ' -f 2 | sed -e 's/trunk/tags/')"
# I prefer to git-svn rebase to fetch
git_svn_update = git svn rebase
# This hack is here because git pull stupidly outputs tag info to stderr.
# Shut it up but let real errors through, for use in cron.
quietupdate = mr -s -n update 3>&1 1>/dev/null 2>&3 | egrep -v '(storing tag|tag: )' || true
lib =
    # Tests used below.
    hostname="$(hostname)"
    whoami="$(whoami)"
    full() {
        test "$whoami" = skangas
    }
    on() {
        for host in $@; do
            if [ "${host%@*}" != "${host#*@}" ]; then
                if [ "$whoami" != "${host%@*}" ]; then
                    continue
                fi
                host="${host#*@}"
            fi
            if [ "$hostname" = "$host" ]; then
                return 0
            fi
        done
        return 1
    }
    private() {
        on skangas@huey skangas@kollontaj
    }
    wantx() {
        on skangas@huey skangas@kollontaj
    }
    # Macros
    github_clone() {
        git clone "git://github.com/skangas/$1" $2
        cd $2
        git remote set-url --push origin git@github.com:skangas/$1
    }
    github_fake_bare_checkout() {
        git_fake_bare_checkout "git://github.com/skangas/$1" "$2" '../../'
        GIT_DIR=$PWD
        export GIT_DIR
        git remote set-url --push origin "git@github.com:skangas/$1"
    }

#########################################################################
# emacs

[.etc/emacs.git]
order = 1
checkout = github_fake_bare_checkout 'dot-emacs.git' 'emacs.git' '../../'

[.emacs.d/lisp/zenburn]
checkout = github_clone 'zenburn-el.git' 'zenburn'
skip = ([ "$1" = update ] && ! hours_since "$1" 72)
push = echo "can't push!"
order = 5

#########################################################################
# all -- these are to be on all hosts

[bin]
checkout = github_clone 'home-bin.git' 'bin'

[.etc/aspell.git]
checkout = github_fake_bare_checkout 'dot-aspell.git' 'aspell.git'

[.etc/bash.git]
checkout = github_fake_bare_checkout 'dot-bash.git' 'bash.git'

[.etc/bazaar.git]
checkout = github_fake_bare_checkout 'dot-bazaar.git' 'bazaar.git'

[.etc/cpanplus.git]
checkout = github_fake_bare_checkout 'dot-cpanplus.git' 'cpanplus.git'

[.etc/git.git]
checkout = github_fake_bare_checkout 'dot-git.git' 'git.git'

[.etc/kernel-pkg.git]
checkout = github_fake_bare_checkout 'dot-kernel-pkg.git' 'kernel-pkg.git'

[.etc/mr.git]
checkout = github_fake_bare_checkout 'dot-mr.git' 'mr.git'

[.etc/rtorrent.git]
checkout = mkdir -p ~/download/bittorrent ; mkdir -p ~/download/torrents ; mkdir -p ~/.rtorrent-session ; github_fake_bare_checkout 'dot-rtorrent.git' 'rtorrent.git'

[.etc/screen.git]
checkout = github_fake_bare_checkout 'dot-screen.git' 'screen.git'

[.etc/ssh.git]
checkout = github_fake_bare_checkout 'dot-ssh.git' 'ssh.git'

#########################################################################
# private -- pull to home and laptop only

[.etc/irssi.git]
checkout = git_fake_bare_checkout 'skangas@huey.skangas.se:.repos/dot-irssi.git' 'irssi.git' '../../'
skip = ! private

[.etc/gnus.git]
checkout = git_fake_bare_checkout 'skangas@huey.skangas.se:.repos/dot-gnus.git' 'gnus.git' '../../'
skip = ! private

[.etc/mailfilter.git]
checkout = git_fake_bare_checkout 'skangas@huey.skangas.se:.repos/dot-mailfilter.git' 'mailfilter.git' '../../'
skip = ! private

[.etc/offlineimap.git]
checkout = git_fake_bare_checkout 'skangas@huey.skangas.se:.repos/dot-offlineimap.git' 'offlineimap.git' '../../'
skip = ! private

[.etc/secrets.git]
checkout = git_fake_bare_checkout 'skangas@huey.skangas.se:.repos/dot-secrets.git' 'secrets.git' '../../'
skip = ! private

[dokument]
checkout = git clone skangas@huey.skangas.se:.repos/home-dokument.git dokument
skip = ! private

[dokument/avanti]
checkout = git clone skangas@huey.skangas.se:.repos/dokument/avanti.git dokument/avanti
skip = ! private

[org]
checkout = git clone skangas@huey.skangas.se:.repos/home-org.git org
skip = ! private

#########################################################################
# wantx

[.etc/conkeror.git]
checkout = github_fake_bare_checkout 'dot-conkeror.git' 'conkeror.git'
skip = ! wantx

[.etc/fonts.git]
checkout = github_fake_bare_checkout 'dot-fonts.git' 'fonts.git'
skip = ! wantx

[.etc/mpd.git]
checkout = github_fake_bare_checkout 'dot-mpd.git' 'mpd.git'
skip = ! on skangas@huey skangas@kollontaj

[.etc/mplayer.git]
checkout = github_fake_bare_checkout 'dot-mplayer.git' 'mplayer.git'
skip = ! wantx

[.etc/xorg.git]
checkout = github_fake_bare_checkout 'dot-xorg.git' 'xorg.git'
skip = ! wantx

[.etc/xmonad.git]
checkout = github_fake_bare_checkout 'dot-xmonad.git' 'xmonad.git'
skip = ! wantx

#########################################################################
# some sources

[src/mr]
order=50
checkout = git clone git://git.kitenet.net/mr
skip = ([ "$1" = update ] && ! hours_since "$1" 24)
push = echo "can't push!"
